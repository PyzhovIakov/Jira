
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Функция ПолучитьМассивЖурналов() Экспорт
	Ответственный = Пользователи.АвторизованныйПользователь();
	ДатаЖурнала = НачалоНедели(ТекущаяДатаСеанса());
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	CRM_ЖурналыВстреч.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.CRM_ЖурналыВстреч КАК CRM_ЖурналыВстреч
	|ГДЕ
	|	CRM_ЖурналыВстреч.Ответственный = &Ответственный
	|	И CRM_ЖурналыВстреч.ДатаНачала = &ДатаЭтойНедели
	|
	|УПОРЯДОЧИТЬ ПО
	|	CRM_ЖурналыВстреч.ДатаНачала";
	Запрос.УстановитьПараметр("Ответственный", Ответственный);
	Запрос.УстановитьПараметр("ДатаЭтойНедели", ДатаЖурнала);
	ТабЖурналов = Запрос.Выполнить().Выгрузить();
	Если ТабЖурналов.Количество() = 0 Тогда
		НовыйЖурнал = Справочники.CRM_ЖурналыВстреч.СоздатьЭлемент();
		НовыйЖурнал.Ответственный = Ответственный;
		НовыйЖурнал.ДатаНачала = ДатаЖурнала; 
		НовыйЖурнал.Наименование = Ответственный.Наименование + "/" + НеделяГода(ДатаЖурнала) 
			+ " неделя (" + ПредставлениеПериода(ДатаЖурнала, КонецНедели(ДатаЖурнала)) 
			+ ")";
		НовыйЖурнал.Статус = Перечисления.CRM_СтатусыСогласованияПланированияВстреч.Подготовка;
		НовыйЖурнал.Записать();
		НайденныйЖурнал = НовыйЖурнал.Ссылка;
	Иначе	
		НайденныйЖурнал = ТабЖурналов[0].Ссылка;
	КонецЕсли;	
	Возврат Новый Структура("Ключ", НайденныйЖурнал);
КонецФункции

#КонецОбласти

#КонецЕсли
