<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">{{CRM:PATH_TO_LIBRARY}}<style>html{height:100%;font-family:Arial;font-style:normal;overflow:hidden}*{cursor:default;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}body{width:100%;height:100%;margin:0;padding:0}#d3-diagram-wrap{width:100%;height:100%}.bar-element>*{cursor:pointer}#d3-context-menu{position:absolute;min-width:100px;z-index:9999;border-radius:1px;padding:6px 0;background-color:#fff;border:1px solid #e5e5e5}#d3-context-ul{margin:0;padding:0;list-style-type:none}#d3-context-ul li{display:block;padding:6px 12px;font-size:12px;line-height:14px;color:#2c2c2c;text-decoration:none}#d3-context-ul li:hover{cursor:pointer;background-color:#e2e2e2}#d3-tooltip{position:absolute;z-index:9999;padding:10px;background:rgba(255,255,255,.8);border:1px solid;border-width:2px;border-radius:4px}.tooltip-centered-header{text-align:center}#tooltip-header{margin:0;font-size:12px;display:flex;align-items:center}.tooltip-secondary-text-wrap{padding:2px 0}.tooltip-secondary-text-wrap p{margin:0;padding:0;font-size:10px;font-style:italic}#tooltip-ref{font-size:10px;margin:0;padding:0;color:#00a0f2}#tooltip-ref:hover{cursor:pointer!important}#tooltip-bar-color{width:14px;height:14px;display:inline-block;margin-right:8px}</style></head><body><div id="d3-diagram-wrap"><svg id="d3-diagram"></svg></div><script>function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=Array(e);n<e;n++)a[n]=t[n];return a}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var a,r,o,i,l=[],c=!0,d=!1;try{if(o=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(a=o.call(n)).done)&&(l.push(a.value),l.length!==e);c=!0);}catch(t){d=!0,r=t}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(d)throw r}}return l}}function _arrayWithHoles(t){if(Array.isArray(t))return t}var ext_selectedBarData,format,showContextMenu="{{CRM:SHOW_CONTEXT_MENU_FLAG}}",isMoneyValues="{{CRM:IS_MONEY_VALUES}}",data="{{CRM:DATA}}",margin={top:15,right:50,bottom:15,left:75},colors=new Map(Object.entries("{{CRM:COLORS}}")),colorScale=d3.scaleOrdinal().domain(colors.keys()).range(colors.values()),isAnimationDone=!1;function windowOnResize(){var t=document.getElementById("d3-diagram-wrap"),e=t.getBoundingClientRect();t.innerHTML='<svg id="d3-diagram"></svg><div id="d3-context-menu"></div><div id="d3-tooltip">\n          <h5 id="tooltip-header"></h5>\n          <div class="tooltip-secondary-text-wrap">\n            <p id="tooltip-value"></p>\n            <p id="tooltip-avg"></p>\n          </div>\n          <a href="РасшифроватьСтолбецДиаграммы" id="tooltip-ref">Расшифровать</a>\n        </div>',document.getElementById("tooltip-ref").onclick=transcribeColumn,drawPlot(e,margin)}function drawPlot(e,n){var l=!1,c=!1,t=d3.stack().keys(d3.union(data.map(function(t){return t.source}))).value(function(t,e){e=_slicedToArray(t,2)[1].get(e);return e?e.barValue:0})(d3.index(data,function(t){return t.status},function(t){return t.source})),d=d3.scaleLinear().domain([0,d3.max(t,function(t){return d3.max(t,function(t){return t[1]})})]).range([n.left,e.width-n.right]),s=d3.scaleBand().domain(d3.groupSort(data,function(t){return t.barValue},function(t){return t.status})).range([n.top,e.height-n.bottom-n.top]).padding(.08),a=d3.select("svg").attr("width",e.width).attr("height",e.height).attr("viewBox",[0,0,e.width,e.height]).attr("style","max-width: 100%; height: 100%;").on("click",function(t){l&&2!==t.buttons?(t.preventDefault(),t.stopPropagation()):ext_selectedBarData=void 0,y()});showContextMenu&&a.on("contextmenu",function(n){n.preventDefault();var a=!1,t=d3.pointer(n,document.getElementById("d3-diagram"));f.selectAll("li").each(function(t){var e=t.visibility(n);e&&(a=!0);d3.select(this).style("display",e?"block":"none").on("click",function(){t.action(n),y()})});i&&(changeBarSelection(i),i=void 0);"rect"===n.target.nodeName&&(o=d3.select(n.target),r=d3.select(n.target.parentNode),changeBarSelection(o,r.attr("fill")),i=o);if(!a)return void y();u.style("display","none");var e=window.innerWidth||document.documentElement.clientWidth,r=window.innerHeight||document.documentElement.clientHeight,o=document.getElementById("d3-context-menu").getBoundingClientRect();startX=t[0]<e/2?t[0]:t[0]-o.width,startY=t[1]<r/2?t[1]:t[1]-o.height,p.style("display","block"),p.style("left","".concat(startX,"px")),p.style("top","".concat(startY,"px")),l=!0}),a.append("g").attr("transform","translate(0,".concat(e.height-n.bottom-n.top,")")).call(d3.axisBottom(d).ticks(e.width/100,"s")).call(function(t){return t.selectAll(".tick line").clone().attr("y2",-(e.height-2*n.top-n.bottom)).attr("stroke-opacity",.25).attr("stroke-dasharray","2,2")}),a.append("g").attr("transform","translate(".concat(n.left,", 0)")).call(d3.axisLeft(s).tickSizeOuter(0)).selectAll("text").call(wrap,75);t=a.append("g").selectAll().data(t).join("g").selectAll("rect").data(function(e){return e.map(function(t){return t.key=e.key,t})}).join("g").attr("class","bar-element").on("mouseenter",function(t,e){if(l)return;u.style("display","block");var n=e.data[1].get(e.key),a=colorScale(e.key),r=d3.select(t.target),o=r.node().getBBox();changeBarSelection(r,a),u.select("#tooltip-header").html('<span id="tooltip-bar-color" style=\'background-color: '.concat(a,"'></span>")+e.data[0]+" ("+e.key+")"),u.select("#tooltip-value").html("Значение: "+format(e[1]-e[0]));var i=u.select("#tooltip-avg");n&&n.avgStageTime?(i.style("display",null),i.html("Средний срок на этапе: "+n.avgStageTime)):i.style("display","none");t=u.node().getBoundingClientRect(),r=window.innerWidth||document.documentElement.clientWidth,n=window.innerHeight||document.documentElement.clientHeight,i=d(e[0])+o.width/2,o=s(e.data[0])+o.height/2;i=i<r/2?i:i-t.width,o=o<n/2?o:o-t.height,u.style("left","".concat(i,"px")),u.style("top","".concat(o,"px")),u.style("border-color",a),c=!0}).on("mouseout",function(t){if(l)return;var e=u.node();c=e.contains(t.relatedTarget)}).on("mouseleave",r).on("touchstart",function(t){return t.preventDefault()}).on("dblclick",barOnClick).on("click",function(t){t.stopPropagation(),y()});t.append("rect").attr("fill",function(t){return colorScale(t.key)}).attr("x",function(t){return d(t[0])}).attr("y",function(t){return s(t.data[0])}).attr("height",s.bandwidth()).attr("width",function(t){return d(t[1])-d(t[0])}),t.filter(function(t,e){return t[1]-t[0]}).append("text").attr("fill",function(t){t=d3.rgb(colorScale(t.key));return 180<.2126*t.r+.7152*t.g+.0722*t.b?"black":"white"}).attr("font-family","sans-serif").attr("font-size","10px").attr("x",function(t){return d(t[0])+(d(t[1])-d(t[0]))/2}).attr("y",function(t){return s(t.data[0])+s.bandwidth()/2}).attr("text-anchor","middle").attr("dy","0.33em").text(function(t){return format(t[1]-t[0])}).each(function(t){var e=this.getBBox(),n=d(t[1])-d(t[0]),t=d(t[0]);e.x>=t&&e.x+e.width-20<=t+n||d3.select(this).remove()});var u=d3.select("#d3-tooltip");function r(t){l||(t.target===u.node()&&(c=!1),c||(u.style("display","none"),changeBarSelection(d3.select("#selected-bar"))))}u.on("mouseenter",function(t){u.style("display","block"),c=!0}).on("mouseleave",r);var i,t=[{title:"Перестроить",action:function(t){var e=document.createEvent("MouseEvents");e.initEvent("dblclick",!0,!0),t.target.dispatchEvent(e)},visibility:function(t){return"rect"===t.target.nodeName}},{title:"Сбросить",action:function(t){ext_selectedBarData=void 0},visibility:function(t){return void 0!==ext_selectedBarData}}],p=d3.select("#d3-context-menu"),f=p.append("ul");f.attr("id","d3-context-ul");f.selectAll("li").data(t).enter().append("li").each(function(t){d3.select(this).html(t.title)});function y(){l=!1,p.style("display","none"),i&&(changeBarSelection(i),i=void 0)}}function changeBarSelection(t,e){var n=t.select("rect"),a=t.select("text");e?(t.attr("id","selected-bar"),n.style("fill",e.replace("rgb(","rgba(").replace(")",",0.65)")),n.style("stroke",e),n.style("stroke-width","2"),a.style("display","none")):(t.attr("id",null),n.style("stroke",null),n.style("fill",null),n.style("stroke-width",null),a.style("display",null))}function barOnClick(t,e){setExtSelectedBarData(e),document.getElementById("d3-diagram-wrap").click()}function transcribeColumn(t){t.preventDefault();t=d3.select("#selected-bar");t&&setExtSelectedBarData(t.datum())}function setExtSelectedBarData(t){sourceItem=t.key,dataCollection=t.data[1],ext_selectedBarData=dataCollection.get(sourceItem)}function wrap(t,i){t.each(function(){for(var t,e=d3.select(this),n=e.text().split(/\s+/).reverse(),a=[],r=0,o=e.text(null).append("tspan").style("width",i+"px");t=n.pop();)a.push(t),o.text(a.join(" ")),o.node().getComputedTextLength()>i&&(a.pop(),o.text(a.join(" ")),a=[t],o=e.append("tspan").attr("x",e.attr("x")).attr("dy","1em").text(t),r+=1);e.attr("dy",parseFloat(e.attr("dy"))+-r/2+"em")})}format=isMoneyValues?d3.formatLocale({decimal:",",thousands:" ",grouping:[3]}).format(",.2f"):d3.formatLocale({thousands:" ",grouping:[3]}).format(","),window.addEventListener("resize",windowOnResize),windowOnResize();</script></body></html>