<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">{{CRM:PATH_TO_LIBRARY}}<style>html{height:100%;font-family:Arial;font-style:normal;overflow:hidden}*{cursor:default;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}body{width:100%;height:100%;margin:0;padding:0}#d3-diagram-wrap{width:100%;height:100%}#d3-row-elements{height:100%;display:flex;flex-direction:row;align-items:center;justify-items:center}#d3-tooltip{position:absolute;z-index:9999;padding:10px;background:rgba(255,255,255,.8);border:1px solid;border-width:2px;border-radius:4px}.tooltip-centered-header{text-align:center}#tooltip-header{margin:0;font-size:12px;display:flex;align-items:center}.tooltip-secondary-text-wrap{padding:2px 0}.tooltip-secondary-text-wrap p{margin:0;padding:0;font-size:10px;font-style:italic}#tooltip-ref{font-size:10px;margin:0;padding:0;color:#00a0f2}#tooltip-ref:hover{cursor:pointer!important}#tooltip-bar-color{width:14px;height:14px;display:inline-block;margin-right:8px}#d3-swatches{margin-bottom:30px}</style></head><body><div id="d3-diagram-wrap"><svg id="d3-diagram"></svg></div><script>function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,a,o,r,l=[],c=!0,s=!1;try{if(o=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(i=o.call(n)).done)&&(l.push(i.value),l.length!==e);c=!0);}catch(t){s=!0,a=t}finally{try{if(!c&&null!=n.return&&(r=n.return(),Object(r)!==r))return}finally{if(s)throw a}}return l}}function _arrayWithHoles(t){if(Array.isArray(t))return t}var isAnimationDone=!1,format=d3.formatLocale({thousands:" ",grouping:[3]}).format(",");function swatches(t,e){var n=e.columns||null,i=e.format,a=e.unknown,o=e.swatchSize||15,r=e.swatchWidth||o,l=e.swatchHeight||o,o=e.marginLeft||0,c="-swatches-".concat(Math.random().toString(16).slice(2)),s=null==a?void 0:t.unknown(),e=null==s||s===d3.scaleImplicit?[]:[s],e=t.domain().concat(e);function d(t){return Object.entries(t).map(function(t){var e=_slicedToArray(t,2),t=e[0],e=e[1];return"".concat(t,":").concat(e)}).join(";")}return void 0===i&&(i=function(t){return t===s?a:t}),null===n?'<div style="position: absolute; display: -webkit-box; display: -webkit-flex; display: -moz-box; display: -ms-flexbox; display: flex; -webkit-box-align: center; -webkit-align-items: center; -moz-box-align: center; -ms-flex-align: center; align-items: center; margin-left: '.concat(+o,'px; min-height: 33px; font: 10px sans-serif;">\n            <style>\n              .').concat(c,"-item {\n                break-inside: avoid;\n                display: flex;\n                align-items: center;\n                padding-bottom: 1px;\n              }\n              \n              .").concat(c,"-label {\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                max-width: calc(100% - ").concat(+r,"px - 0.5em);\n              }\n              \n              .").concat(c,"-swatch {\n                width: ").concat(+r,"px;\n                height: ").concat(+l,"px;\n                margin: 0 0.5em 0 0;\n              }\n            </style>\n            <div style=").concat(d({width:"100%",columns:n}),">").concat(e.map(function(t){var e="".concat(i(t));return"<div class=".concat(c,"-item>\n                  <div class=").concat(c,"-swatch style=").concat(d({background:colorScale(t)}),"></div>\n                  <div class=").concat(c,"-label title=").concat(e,">").concat(e,"</div>\n                </div>")}).join(""),"\n            </div>\n          </div>"):'<div style="position: absolute; display: -webkit-box; display: -webkit-flex; display: -moz-box; display: -ms-flexbox; display: flex; -webkit-box-align: center; -webkit-align-items: center; -moz-box-align: center; -ms-flex-align: center; align-items: center; min-height: 33px; margin-left: '.concat(+o,'px; font: 10px sans-serif;">\n          <style>\n            .').concat(c," {\n              display: -webkit-inline-box;\n              display: -webkit-inline-flex;\n              display: -moz-inline-box;\n              display: -ms-inline-flexbox;\n              display: inline-flex;\n              -webkit-box-align: center;\n              -webkit-align-items: center;\n              -moz-box-align: center;\n              -ms-flex-align: center;\n              align-items: center;\n              margin-right: 1em;\n            }\n\n            .").concat(c,"-colorBlock {\n              width: ").concat(+r,"px;\n              height: ").concat(+l,"px;\n              margin-right: 0.5em;\n            }\n          </style>\n          <div>").concat(e.map(function(t){return'<div class="'.concat(c,'"><span class="').concat(c,'-colorBlock" style="background-color: ').concat(colorScale(t),'"></span>').concat(i(t),"</div>")}).join(""),"</div>\n        </div>")}var data="{{CRM:DATA}}",data=d3.sort(data,function(t){return t.value}),colorKeys=d3.union(data.map(function(t){return t.title})),colorScale=d3.scaleOrdinal(["#4ac2f7","#f78375","#ffd700","#8a2be2","#00ff7f","#ff69b4","#4682b4","#d2691e","#ff4500","#2e8b57","#eaeaea"]).domain(colorKeys),margin={top:15,right:50,bottom:15,left:50};function windowOnResize(){var t=document.getElementById("d3-diagram-wrap"),e=t.getBoundingClientRect();t.innerHTML='<div id="d3-row-elements">\n          <svg id="d3-diagram"></svg>\n          <div id="d3-swatches">'.concat(swatches(colorScale,{}),'</div>\n        </div>\n        <div id="d3-tooltip">\n          <h5 id="tooltip-header"></h5>\n          <div class="tooltip-secondary-text-wrap">\n            <p id="tooltip-value"></p>\n          </div>\n          <a href="РасшифроватьСтолбецДиаграммы" id="tooltip-ref">Расшифровать</a>\n        </div>'),document.getElementById("tooltip-ref").onclick=transcribeColumn,drawPlot(e,margin)}function drawPlot(t,e){var n=d3.pie().sort(null).value(function(t){return t.value}),i=d3.arc().innerRadius(0).outerRadius(Math.min(t.width,t.height)/2-1),a=.8*i.outerRadius()(),o=.5*i.outerRadius()(),r=d3.arc().innerRadius(a).outerRadius(a),l=d3.arc().innerRadius(o).outerRadius(o),n=n(data),n=d3.select("svg").attr("height",t.height).attr("viewBox",[-t.width/2,-t.height/2,t.width,t.height]).attr("style","max-width: 80%; height: 100%;").append("g").attr("stroke","white").attr("id","d3-pie").selectAll().data(n).join("g").attr("class","bar-element").on("mouseenter",function(t,e){c.style("display","block");var n=e.data,i=colorScale(n.title),a=d3.select(t.target);a.node().getBBox();changeBarSelection(a,i),c.select("#tooltip-header").html('<span id="tooltip-bar-color" style=\'background-color: '.concat(i,"'></span>").concat(n.title)),c.select("#tooltip-value").html("Значение: "+format(n.value));var o=c.node().getBoundingClientRect(),r=window.innerWidth||document.documentElement.clientWidth,t=window.innerHeight||document.documentElement.clientHeight,a=l.centroid(e),n=d3.select("#d3-pie").node().getBoundingClientRect(),e=n.x+n.width/2+a[0],a=n.y+n.height/2+a[1];e=e<r/2?e:e-o.width,a=a<t/2?a:a-o.height,c.style("left","".concat(e,"px")),c.style("top","".concat(a,"px")),c.style("border-color",i),isTooltipVisible=!0}).on("mouseout",function(t){var e=c.node();isTooltipVisible=e.contains(t.relatedTarget)}).on("mouseleave",s).on("touchstart",function(t){return t.preventDefault()});isAnimationDone?n.append("path").attr("fill",function(t){return colorScale(t.data.title)}).attr("d",i):(n.append("path").attr("fill",function(t){return colorScale(t.data.title)}).transition().duration(1e3).attrTween("d",function(e){var n=d3.interpolate(e.startAngle+.1,e.endAngle);return function(t){return e.endAngle=n(t),i(e)}}),isAnimationDone=!0),n.append("text").attr("transform",function(t){return"translate(".concat(r.centroid(t),")")}).attr("fill",function(t){t=d3.rgb(colorScale(t.data.title));return 180<.2126*t.r+.7152*t.g+.0722*t.b?"black":"white"}).attr("font-family","sans-serif").attr("font-size","12px").call(function(t){return t.append("tspan").attr("y","-0.4em").attr("fill","white").text(function(t){return t.data.value})});var c=d3.select("#d3-tooltip");function s(t){t.target===c.node()&&(isTooltipVisible=!1),isTooltipVisible||(c.style("display","none"),changeBarSelection(d3.select("#selected-bar")))}c.on("mouseenter",function(t){c.style("display","block"),isTooltipVisible=!0}).on("mouseleave",s)}function changeBarSelection(t,e){var n=t.select("path"),i=t.select("text");e?((e=d3.rgb(e)).opacity=.8,t.attr("id","selected-bar"),n.style("fill",e),i.style("display","none")):(t.attr("id",null),n.style("fill",null),i.style("display",null))}function transcribeColumn(t){t.preventDefault();t=d3.select("#selected-bar");ext_selectedBarData=t?t.datum().data:void 0}window.addEventListener("resize",windowOnResize),windowOnResize();</script></body></html>