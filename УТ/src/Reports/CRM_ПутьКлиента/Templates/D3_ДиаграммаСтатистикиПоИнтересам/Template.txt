<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">{{CRM:PATH_TO_LIBRARY}}<style>html{height:100%;font-family:Arial;font-style:normal;overflow:hidden}*{cursor:default;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}body{width:100%;height:100%;margin:0;padding:0}#d3-diagram-wrap{width:100%;height:100%}#d3-tooltip{position:absolute;z-index:9999;padding:10px;background:rgba(255,255,255,.8);border:1px solid;border-width:2px;border-radius:4px;pointer-events:none}#tooltip-header{margin:0;font-size:12px}.tooltip-secondary-text-wrap{padding:2px 0}.tooltip-secondary-text-wrap p{margin:0;padding:0;font-size:10px;font-style:italic}.tooltip-bar-color{width:21px;height:3px;display:inline-block;margin-right:8px}#tooltip-clicktip{font-size:10px;margin:0;padding:0}#tooltip-arrow{position:absolute;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid}</style></head><body><div id="d3-diagram-wrap"><svg id="d3-diagram"></svg></div><script>var ext_selectedBarData,data="{{CRM:DATA}}",dataCompleted="{{CRM:DATA_COMPLETED}}",ext_showData=data,colorScale=d3.scaleOrdinal(["#4ac2f7","#f78375","#eaeaea"]).domain([!0,!1,null]),margin={top:50,right:50,bottom:50,left:50},format=d3.formatLocale({thousands:" ",grouping:[3]}).format(",");function windowOnResize(){var t=document.getElementById("d3-diagram-wrap"),e=t.getBoundingClientRect();t.innerHTML='<svg id="d3-diagram"></svg><div id="d3-tooltip">\n          <div id="tooltip-arrow"></div>\n          <h5 id="tooltip-header"></h5>\n          <div class="tooltip-secondary-text-wrap">\n            <p id="tooltip-value"></p>\n          </div>\n          <p id="tooltip-clicktip">Нажмите, чтобы расшифровать</p>\n        </div>',drawPlot(ext_showData,e,margin)}function drawPlot(r,t,e){var a=0===(a=d3.max([d3.max(ext_showData,function(t){return t.currentValue}),d3.max(ext_showData,function(t){return t.previousValue})]))?10:a,d=d3.scaleBand().domain(r.map(function(t){return t.period})).range([e.left+e.left/2,t.width-e.right]),s=d3.scaleLinear().domain([0,a]).nice().range([t.height-e.bottom,e.top]),n=d3.select("svg").attr("width",t.width).attr("height",t.height).attr("viewBox",[0,0,t.width,t.height]).attr("style","max-width: 100%; height: 100%;");n.append("g").attr("transform","translate(".concat(e.left,",0)")).call(d3.axisRight(s).ticks(4).tickSize(t.width-e.left-e.right).tickFormat(d3.format("~s"))).call(function(t){return t.select(".domain").remove()}).call(function(t){return t.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity",.25).attr("stroke-dasharray","2,2")}).call(function(t){return t.selectAll(".tick text").attr("x",4).attr("dy",-4)}),n.append("g").attr("transform","translate(0,".concat(s(0),")")).call(d3.axisBottom(d)).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-45)");var o=d3.area().x(function(t){return d(t.period)+d.bandwidth()/2}).y0(s(0)),l=d3.line().x(function(t){return d(t.period)+d.bandwidth()/2}),u=d3.select("#d3-tooltip"),p=d3.select("#tooltip-arrow"),h=(f(function(t){return s(t.previousValue)},colorScale(!1)),f(function(t){return s(t.currentValue)},colorScale(!0)),n.append("circle").style("display","none").style("stroke","rgb(0, 0, 0, 0.5)").style("stroke-width",15).style("fill","black").attr("r",6).attr("cx",50).attr("cy",20)),i=n.append("g");function c(t,e,a,r){i.append("rect").data([r]).attr("x",t).attr("y",e).attr("height",a).attr("width",d.bandwidth()).attr("opacity",0).on("mouseenter",m).on("mouseleave",y).on("touchstart",function(t){return t.preventDefault()}).on("click",function(t){t.preventDefault(),ext_selectedBarData=r})}function f(t,a){var e=n.append("g").selectAll().data([,]).join("g");return e.append("path").attr("d",o.y1(t)(r)).attr("fill",function(t){var e=d3.rgb(a);return e.opacity=.5,e}),e.append("path").attr("fill","none").attr("stroke",a).attr("stroke-width",2.25).attr("d",l.y(t)(r)),e}function m(t,e){u.style("display","block");var a=e.data,r=colorScale(e.isCurrent),n=(d3.select(t.target),d(a.period)+d.bandwidth()/2),o=s(a.currentValue),l=20;g(r),u.select("#tooltip-header").html(a.period);t=u.select("#tooltip-value");a.currentValue===a.previousValue?t.html('\n            <div style="display: flex; flex-direction: column">\n              <p class="tooltip-bar-value">\n                <span class="tooltip-bar-color" style=\'background-color: '.concat(colorScale(!0),"'></span>\n                Текущий период: ").concat(format(a.currentValue),'\n              </p>\n              <p class="tooltip-bar-value">\n                <span class="tooltip-bar-color" style=\'background-color: ').concat(colorScale(!1),"'></span>\n                Прошлый период: ").concat(format(a.previousValue),"\n              </p>\n            </div>")):(i="",c=0,i=e.isCurrent?(c=a.currentValue,"Текущий период"):(c=a.previousValue,"Прошлый период"),o=s(c),t.html('\n            <p class="tooltip-bar-value"><span class="tooltip-bar-color" style=\'background-color: '.concat(r,"'></span>\n              ").concat(i,": ").concat(c,"\n            </p>"))),h.attr("cx",n).attr("cy",o);a=u.node().getBoundingClientRect(),window.innerWidth||document.documentElement.clientWidth,t=window.innerHeight||document.documentElement.clientHeight;n-=a.width/2;var i="0deg",c=-10;t/2<=o&&(o-=a.height,l=-20,i="-180deg",c=a.height-4),u.style("left","".concat(n,"px")),u.style("top","".concat(o+l,"px")),u.style("border-color",r),p.style("left","".concat(a.width/2-12,"px")),p.style("top","".concat(c,"px")),p.style("transform","rotate(".concat(i,")")),p.style("border-bottom-color",r)}function y(t){u.style("display","none"),g()}function g(t){var e;t?((e=d3.rgb(t)).opacity=.5,h.style("display",null),h.style("stroke",e),h.style("fill",t)):h.style("display","none")}r.forEach(function(t,e){t.currentValue===t.previousValue?c(d(t.period),s(a),s(0)-s(a),{data:t,isCurrent:null,index:e}):t.currentValue>t.previousValue?(c(d(t.period),s(a),s(0)-s(a),{data:t,isCurrent:!0,index:e}),c(d(t.period),s(t.previousValue),s(0)-s(t.previousValue),{data:t,isCurrent:!1,index:e})):(c(d(t.period),s(a),s(0)-s(a),{data:t,isCurrent:!1,index:e}),c(d(t.period),s(t.currentValue),s(0)-s(t.currentValue),{data:t,isCurrent:!0,index:e}))})}window.addEventListener("resize",windowOnResize),windowOnResize();</script></body></html>