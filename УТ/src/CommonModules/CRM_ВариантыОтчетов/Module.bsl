////////////////////////////////////////////////////////////////////////////////
// Подсистема "Варианты отчетов  CRM" (сервер)
// 
// Выполняется на сервере, изменяется под специфику прикладной конфигурации,
// но предназначен для использования только данной подсистемой.
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

////////////////////////////////////////////////////////////////////////////////
// Настройки подсистемы

// Определяет разделы глобального командного интерфейса, в которых предусмотрены панели отчетов.
//  В Разделы необходимо добавить метаданные тех подсистем первого уровня,
//  в которых размещены команды вызова панелей отчетов.
//
// Параметры:
//  Разделы	 - СписокЗначений	 - разделы, в которые выведены команды открытия панели отчетов.
//  	* Значение - ОбъектМетаданных.Подсистема, Строка - подсистема раздела глобального командного интерфейса,
//  	либо ВариантыОтчетовКлиентСервер.ИдентификаторНачальнойСтраницы для начальной страницы.
//  	* Представление - Строка - заголовок панели отчетов в этом разделе.
// Пример:
//	Разделы.Добавить(Метаданные.Подсистемы.Анкетирование,
	// НСтр("ru='Отчеты по анкетированию';en='Reports on questioning'"));
//	Разделы.Добавить(ВариантыОтчетовКлиентСервер.ИдентификаторНачальнойСтраницы(),
	// НСтр("ru='Основные отчеты';en='Basic reports'"));
//
Процедура ОпределитьРазделыСВариантамиОтчетов(Разделы) Экспорт
	
	ИмяКонфигурации = Метаданные.Имя;
	
	Если ИмяКонфигурации = "CRM" Тогда
		
		Разделы.Добавить(Метаданные.Подсистемы["CRM_РазделБизнесПроцессы"],
		НСтр("ru='Отчеты по бизнес-процессам';en='Business Process Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_РазделПроекты"],
		НСтр("ru='Отчеты по проектам';en='Project Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_РазделКалендарьПочта"],
		НСтр("ru='Отчеты по взаимодействиям';en='Interactions Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_РазделМаркетинг"],
		НСтр("ru='Отчеты по маркетингу';en='Marketing Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_РазделРаботаСКлиентами"],
		НСтр("ru='Отчеты по клиентам';en='Customer Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_РазделАдминистрирование"],
		НСтр("ru='Отчеты администратора';en='Administrator Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_ОтчетыРабочегоСтола"],
		НСтр("ru='Отчеты рабочего стола';en='Desktop Reports'"));
		
	Иначе
		
		Разделы.Добавить(Метаданные.Подсистемы["CRM_МодульCRM"].Подсистемы["CRM_РазделБизнесПроцессы"],
		НСтр("ru='Отчеты по бизнес-процессам';en='Business Process Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_МодульCRM"].Подсистемы["CRM_РазделПроекты"],
		НСтр("ru='Отчеты по проектам';en='Project Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_МодульCRM"].Подсистемы["CRM_РазделКалендарьПочта"],
		НСтр("ru='Отчеты по взаимодействиям';en='Interactions Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_МодульCRM"].Подсистемы["CRM_РазделМаркетинг"],
		НСтр("ru='Отчеты по маркетингу';en='Marketing Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_МодульCRM"].Подсистемы["CRM_РазделРаботаСКлиентами"],
		НСтр("ru='Отчеты по клиентам';en='Customer Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_МодульCRM"].Подсистемы["CRM_РазделАдминистрирование"],
		НСтр("ru='Отчеты администратора';en='Administrator Reports'"));
		Разделы.Добавить(Метаданные.Подсистемы["CRM_МодульCRM"].Подсистемы["CRM_ОтчетыРабочегоСтола"],
		НСтр("ru='Отчеты рабочего стола';en='Desktop Reports'"));
	КонецЕсли;
	
КонецПроцедуры

// Задает настройки размещения вариантов отчетов в панели отчетов.
//   Отчет выступает в качестве контейнера вариантов.
//     Изменяя настройки отчета можно сразу изменять настройки всех его вариантов.
//     Однако, если явно получить настройки варианта отчета, то они станут самостоятельными,
//     т.е. более не будут наследовать изменения настроек от отчета.
//   
//   Начальная настройка размещения отчетов по подсистемам зачитывается из метаданных,
//     ее дублирование в коде не требуется.
//   
//   Функциональные опции варианта объединяются с функциональными опциями этого отчета по следующим правилам:
//     (ФО1_Отчета ИЛИ ФО2_Отчета) И (ФО3_Варианта ИЛИ ФО4_Варианта).
//   Функциональные опции отчетов не зачитываются из метаданных,
//     они применяются на этапе использования подсистемы пользователем.
//   Через ОписаниеОтчета можно добавлять функциональные опции, которые будут соединяться по указанным выше правилам,
//     но надо помнить, что эти функциональные опции будут действовать только для предопределенных вариантов отчетов.
//   Для пользовательских вариантов отчета действуют только функциональные опции отчета
//     - они отключаются только с отключением всего отчета.
//
// Параметры:
//   Настройки - Коллекция - настройки отчетов и вариантов отчетов конфигурации.
//                           Для их изменения предназначены следующие вспомогательные процедуры и функции:
//                           ВариантыОтчетов.ОписаниеОтчета, 
//                           ВариантыОтчетов.ОписаниеВарианта, 
//                           ВариантыОтчетов.УстановитьРежимВыводаВПанеляхОтчетов, 
//                           ВариантыОтчетов.НастроитьОтчетВМодулеМенеджера.
//
// Пример:
//
//  //Добавление варианта отчета в подсистему.
//	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки, Метаданные.Отчеты.ИмяОтчета, "<ИмяВарианта>");
//	НастройкиВарианта.Размещение.Вставить(Метаданные.Подсистемы.ИмяРаздела.Подсистемы.ИмяПодсистемы);
//
//  //Отключение варианта отчета.
//	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки, Метаданные.Отчеты.ИмяОтчета, "<ИмяВарианта>");
//	НастройкиВарианта.Включен = Ложь;
//
//  //Отключение всех вариантов отчета, кроме одного.
//	НастройкиОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты.ИмяОтчета);
//	НастройкиОтчета.Включен = Ложь;
//	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки, НастройкиОтчета, "<ИмяВарианта>");
//	НастройкиВарианта.Включен = Истина;
//
//  //Заполнение настроек для поиска - наименования полей, параметров и отборов:
//	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки, Метаданные.Отчеты.ИмяОтчетаБезСхемы, "");
//	НастройкиВарианта.НастройкиДляПоиска.НаименованияПолей =
//		НСтр("ru = 'Контрагент
//		|Договор
//		|Ответственный
//		|Скидка
//		|Дата'");
//	НастройкиВарианта.НастройкиДляПоиска.НаименованияПараметровИОтборов =
//		НСтр("ru = 'Период
//		|Ответственный
//		|Контрагент
//		|Договор'");
//
//  //Переключение режима вывода в панелях отчетов:
//  //Группировка вариантов отчета по этому отчету:
//	ВариантыОтчетов.УстановитьРежимВыводаВПанеляхОтчетов(Настройки, Метаданные.Отчеты.ИмяОтчета, Истина);
//  //Без группировки по отчету:
//	Отчет = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты.ИмяОтчета);
//	ВариантыОтчетов.УстановитьРежимВыводаВПанеляхОтчетов(Настройки, Отчет, Ложь);
//
Процедура НастроитьВариантыОтчетов(Настройки) Экспорт
	
	РазмещениеВПодсистемеРабочегоСтола(Настройки);
	
	ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты.CRM_СтруктураВзаимосвязейМеждуКлиентами);
	ОписаниеОтчета.Включен = Ложь;
	
	ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты.CRM_КарточкаПроекта);
	ОписаниеОтчета.Включен = Ложь;
	
	Если CRM_ОбщегоНазначенияПовтИсп.ЭтоCRM() Тогда
		ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты["CRM_КарточкаКлиента"]);
		ОписаниеОтчета.Включен = Ложь;

		ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты["CRM_ABCXYZРаспределениеКлиентов"]);
		ОписаниеОтчета.ОпределитьНастройкиФормы = Истина;

		ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты["CRM_АнализЛояльностиКлиентовXYZ"]);
		ОписаниеОтчета.ОпределитьНастройкиФормы = Истина;

		ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты["CRM_ИзменениеABCXYZРаспределенияКлиентов"]);
		ОписаниеОтчета.ОпределитьНастройкиФормы = Истина;
	КонецЕсли;
	
	ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты["CRM_СправкаОбИсполнительскойДисциплине"]);
	ОписаниеОтчета.ОпределитьНастройкиФормы = Истина;
	
	ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки, Метаданные.Отчеты.CRM_КонтрольРуководителя_Интересы);
	ОписаниеОтчета.ОпределитьНастройкиФормы = Истина;
	
	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки,
		 Метаданные.Отчеты.CRM_АнализКлиентскойБазы,
		 "ПоТипамОтношенийИВидамДеятельности");
	НастройкиВарианта.ВидимостьПоУмолчанию = Ложь;

	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки,
		 Метаданные.Отчеты.CRM_КонтрольРуководителя_Интересы,
		 "КасанияНаОдногоКлиента");
	НастройкиВарианта.ВидимостьПоУмолчанию = Ложь;
	
	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки,
		 Метаданные.Отчеты.CRM_ПричиныПотериОбращений,
		 "Основной");
	НастройкиВарианта.ВидимостьПоУмолчанию = Ложь;
	
	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки,
		 Метаданные.Отчеты.CRM_АнализРезультатовEmailРассылок,
		 "ПроблемыПриДоставкеПисемРассылок");
	НастройкиВарианта.ВидимостьПоУмолчанию = Ложь;
	
	ОписаниеОтчета = ВариантыОтчетов.ОписаниеОтчета(Настройки,
		 Метаданные.Отчеты.CRM_АнализТелемаркетингаПоЗвонкамИИнтересам);
	ОписаниеОтчета.ОпределитьНастройкиФормы = Истина;
	
	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки,
		 Метаданные.Отчеты.CRM_АнализТелемаркетингаПоЗвонкамИИнтересам,
		 "ОсновнойБезСФ");
	НастройкиВарианта.ВидимостьПоУмолчанию = Ложь;
	НастройкиВарианта.Включен = Ложь;
	
	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки,
		 Метаданные.Отчеты.CRM_АнализТелемаркетингаПоЗвонкамИИнтересам,
		 "ПоТелемаркетингу");
	НастройкиВарианта.ВидимостьПоУмолчанию = Ложь;
	НастройкиВарианта.Включен = Ложь;
	
	НастройкиВарианта = ВариантыОтчетов.ОписаниеВарианта(Настройки,
		 Метаданные.Отчеты.CRM_АнализТелемаркетингаПоЗвонкамИИнтересам,
		 "ПоТелемаркетингуБезСФ");
	НастройкиВарианта.ВидимостьПоУмолчанию = Ложь;
	НастройкиВарианта.Включен = Ложь;
	
	CRM_УправлениеЦелевымиПоказателямиСервер.НастроитьВариантыОтчетов(Настройки);
	
	// +Виджеты
	Справочники.CRM_Виджеты.НастроитьВариантыОтчетов(Настройки);
	// -Виджеты
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// +CRM

// Выполняет размещение в подсистеме рабочего стола.
//
// Параметры:
//   Настройки - см. ВариантыОтчетов.КоллекцияПредопределенныхВариантовОтчетов
//
Процедура РазмещениеВПодсистемеРабочегоСтола(Настройки) Экспорт
	
	Если CRM_ОбщегоНазначенияПовтИсп.ЭтоCRM() Тогда
		Подсиситема = Метаданные.Подсистемы["CRM_ОтчетыРабочегоСтола"];
	Иначе
		Подсиситема = Метаданные.Подсистемы["CRM_МодульCRM"].Подсистемы["CRM_ОтчетыРабочегоСтола"];
	КонецЕсли;
	ПодсистемыОтчетов = РазмещениеОтчетовВПодсистемах(, Подсиситема);
	КэшФлажкаХранилища = Неопределено;
	Для Каждого НастройкаОтчета Из Настройки Цикл
		
		Если НЕ НастройкаОтчета.ИспользуетСКД Тогда
			Продолжить;	
		КонецЕсли;	
		Если Не ВариантыОтчетов.ОтчетПодключенКХранилищу(НастройкаОтчета.Метаданные, КэшФлажкаХранилища) Тогда
			Продолжить;
		КонецЕсли;
		
		Найденные = ПодсистемыОтчетов.НайтиСтроки(Новый Структура("ОтчетМетаданные", НастройкаОтчета.Метаданные));
		Для Каждого СтрокаПодсистема Из Найденные Цикл
			НастройкаОтчета.Размещение.Вставить(СтрокаПодсистема.ПодсистемаМетаданные, "");
		КонецЦикла;
	
	КонецЦикла;
	
КонецПроцедуры

Функция РазмещениеОтчетовВПодсистемах(Результат = Неопределено, ПодсистемаРодитель = Неопределено)
	Если Результат = Неопределено Тогда
		ПолноеИмяОписаниеТипов = Метаданные.Справочники.ИдентификаторыОбъектовМетаданных.Реквизиты.ПолноеИмя.Тип;
		
		Результат = Новый ТаблицаЗначений;
		Результат.Колонки.Добавить("ОтчетМетаданные",      Новый ОписаниеТипов("ОбъектМетаданных"));
		Результат.Колонки.Добавить("ОтчетПолноеИмя",       ПолноеИмяОписаниеТипов);
		Результат.Колонки.Добавить("ПодсистемаМетаданные", Новый ОписаниеТипов("ОбъектМетаданных"));
		Результат.Колонки.Добавить("ПодсистемаПолноеИмя",  ПолноеИмяОписаниеТипов);
		
		Результат.Индексы.Добавить("ОтчетПолноеИмя");
		
		ПодсистемаРодитель = Метаданные;
	КонецЕсли;
	
	// Перебор вложенных подсистем родителя.
	Для Каждого ПодсистемаМетаданные Из ПодсистемаРодитель.Подсистемы Цикл
		
		Если ПодсистемаМетаданные.ВключатьВКомандныйИнтерфейс Тогда
			Для Каждого ОтчетМетаданные Из ПодсистемаМетаданные.Состав Цикл
				Если Не Метаданные.Отчеты.Содержит(ОтчетМетаданные) Тогда
					Продолжить;
				КонецЕсли;
				
				СтрокаТаблицы = Результат.Добавить();
				СтрокаТаблицы.ОтчетМетаданные      = ОтчетМетаданные;
				СтрокаТаблицы.ОтчетПолноеИмя       = ОтчетМетаданные.ПолноеИмя();
				СтрокаТаблицы.ПодсистемаМетаданные = ПодсистемаМетаданные;
				СтрокаТаблицы.ПодсистемаПолноеИмя  = ПодсистемаМетаданные.ПолноеИмя();
				
			КонецЦикла;
		КонецЕсли;
		
		РазмещениеОтчетовВПодсистемах(Результат, ПодсистемаМетаданные);
	КонецЦикла;
	
	Возврат Результат;
КонецФункции

// -CRM

#КонецОбласти
