#Область ОбработчикиСобытийФормы
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ЗадачаПараметр = Неопределено;
	Если Параметры.Свойство("Задача", ЗадачаПараметр) Тогда
		Задача = ЗадачаПараметр;
	КонецЕсли;
КонецПроцедуры
#КонецОбласти

#Область ОбработчикиКомандФормы
&НаКлиенте
Процедура ОтменаЗакрытия(Команда)
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьЗакрыть(Команда)
	ЗаписатьЗакрытьНаСервере();
	Закрыть();
КонецПроцедуры
#КонецОбласти

#Область СлужебныеПроцедурыИФункции
&НаСервере
Процедура ЗаписатьЗакрытьНаСервере()
	Док = Задача.ПолучитьОбъект();
	Док.ПричинаЗакрытия = Причина;
	Док.Записать(РежимЗаписиДокумента.Проведение);

	Подписка = ПредопределенноеЗначение(
		"Перечисление.cbr_ПодпискаДляТриггера.КнопкаЗакрытияЗадачи");
	cbr_ОбработкаТриггеровВызовСервера.ВызовТриггера(Подписка, Задача);

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	cbr_Задача.Дата,
	|	cbr_Задача.Наименование,
	|	cbr_Задача.ВидЗадачи,
	|	cbr_Задача.Постановщик,
	|	cbr_Задача.ГлавныйМенеджер,
	|	cbr_Задача.ТребуетКонтроляПоЗавершению
	|ИЗ
	|	Документ.cbr_Задача КАК cbr_Задача
	|ГДЕ
	|	cbr_Задача.Ссылка = &Задача";

	Запрос.УстановитьПараметр("Задача", Задача);

	РезультатЗапроса = Запрос.Выполнить();

	Выборка = РезультатЗапроса.Выбрать();

	Если Выборка.Следующий() Тогда
		Если Выборка.ТребуетКонтроляПоЗавершению Тогда
			ПодчиненнаяЗадача = Документы.cbr_Задача.СоздатьДокумент();
			ПодчиненнаяЗадача.Дата = ТекущаяДатаСеанса();
			ПодчиненнаяЗадача.Наименование = "Поверка задачи " + Выборка.Наименование + " от " + Формат(Выборка.Дата,
				"ДФ=dd.MM.yyyy");
			ПодчиненнаяЗадача.ВидЗадачи = Выборка.ВидЗадачи;
			ПодчиненнаяЗадача.Постановщик = Выборка.Постановщик;
			ПодчиненнаяЗадача.ГлавнаяЗадача = Задача;
			ПодчиненнаяЗадача.Автор = Пользователи.АвторизованныйПользователь();
			ПодчиненнаяЗадача.Записать(РежимЗаписиДокумента.Проведение);

			Если ТипЗнч(Выборка.Постановщик) = Тип("СправочникСсылка.Партнеры") Тогда
				Исполнитель = Выборка.ГлавныйМенеджер;
			Иначе
				Исполнитель = Выборка.Постановщик;
			КонецЕсли;

			cbr_ДвиженияПоРегистрам.ДвижениеИсполнителиЗадач(Задача, Исполнитель);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры
#КонецОбласти